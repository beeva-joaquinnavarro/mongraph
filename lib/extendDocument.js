// Generated by CoffeeScript 1.6.2
var processtools, _s;

processtools = require('./processtools');

_s = require('underscore.string');

module.exports = function(mongoose, graphdb, globalOptions) {
  var Document, node, _queryGraphDB;

  Document = mongoose.Document;
  node = graphdb.createNode();
  Document.prototype._graphdb = {
    db: graphdb
  };
  _queryGraphDB = function(cypher, options, cb) {
    var _ref;

    if (options == null) {
      options = {};
    }
    if ((_ref = options.loadDocuments) == null) {
      options.loadDocuments = true;
    }
    if (processtools.constructorNameOf(options.mongodbConnection) !== 'NativeConnection') {
      return cb("Set 'option.mongodbConnection' with a NativeConnection to process query", null);
    }
    return graphdb.query(cypher, function(err, map) {
      var data, result;

      if (err) {
        err.query = cypher;
      }
      if (options.loadDocuments && (map != null ? map.length : void 0) > 0) {
        data = (function() {
          var _i, _len, _results;

          _results = [];
          for (_i = 0, _len = map.length; _i < _len; _i++) {
            result = map[_i];
            if (options.processPart) {
              _results.push(result[options.processPart]);
            } else {
              _results.push(result[Object.keys(result)[0]]);
            }
          }
          return _results;
        })();
        if (processtools.constructorNameOf(data[0]) === 'Relationship') {
          return processtools.loadDocumentsFromRelationshipArray(options.mongodbConnection, data, cb);
        } else {
          return processtools.loadDocumentsFromNodeArray(data, cb);
        }
      } else {
        if (typeof cb === 'function') {
          return cb(err, map);
        }
      }
    });
  };
  Document.prototype.findEquivalentNode = function(cb, doCreateIfNotExists) {
    var collectionName, doc, id;

    if (doCreateIfNotExists == null) {
      doCreateIfNotExists = false;
    }
    doc = this;
    collectionName = doc.constructor.collection.name;
    id = processtools.getObjectIDAsString(doc);
    return graphdb.getIndexedNode(collectionName, '_id', id, function(foundErr, node) {
      if (node) {
        node.document = doc;
      }
      if (doCreateIfNotExists && !node) {
        node = graphdb.createNode({
          _id: id,
          collection: collectionName
        });
        if (globalOptions.storeDocumentInGraphDatabase) {
          node.data = doc.toObject(globalOptions.storeDocumentInGraphDatabase);
        }
        return node.save(function(saveErr) {
          if (saveErr) {
            return cb(saveErr, node);
          }
          return node.index(collectionName, '_id', id, function(indexErr) {
            node.document = doc;
            return cb(indexErr, node);
          });
        });
      } else {
        if (typeof cb === 'function') {
          return cb(null, node);
        }
      }
    });
  };
  Document.prototype.findOrCreateEquivalentNode = function(cb) {
    return this.findEquivalentNode(cb, true);
  };
  Document.prototype.getNode = function(cb) {
    return this.findOrCreateEquivalentNode(cb);
  };
  Document.prototype.createRelationshipTo = function(doc, kindOfRelationship, attributes, cb) {
    var _ref, _ref1, _ref2;

    if (attributes == null) {
      attributes = {};
    }
    if (typeof attributes === 'function') {
      cb = attributes;
      attributes = {};
    }
    if (globalOptions.relationships.storeIDsInRelationship) {
      if ((_ref = attributes._to) == null) {
        attributes._to = doc.constructor.collection.name + ":" + String(doc._id);
      }
      if ((_ref1 = attributes._from) == null) {
        attributes._from = this.constructor.collection.name + ":" + String(this._id);
      }
    }
    if (globalOptions.relationships.storeTimestamp) {
      if ((_ref2 = attributes._created_at) == null) {
        attributes._created_at = Math.floor(Date.now() / 1000);
      }
    }
    return this.findOrCreateEquivalentNode(function(fromErr, from) {
      return doc.findOrCreateEquivalentNode(function(toErr, to) {
        if (from && to) {
          return from.createRelationshipTo(to, kindOfRelationship, attributes, cb);
        } else {
          if (typeof cb === 'function') {
            return cb(fromErr || toErr, null);
          }
        }
      });
    });
  };
  Document.prototype.createRelationshipFrom = function(doc, kindOfRelationship, attributes, cb) {
    if (attributes == null) {
      attributes = {};
    }
    return doc.createRelationshipTo(this, kindOfRelationship, attributes, cb);
  };
  Document.prototype.createRelationshipBetween = function(doc, kindOfRelationship, attributes, cb) {
    var found, self;

    if (attributes == null) {
      attributes = {};
    }
    self = this;
    found = [];
    return this.createRelationshipTo(doc, kindOfRelationship, attributes, function(err, first) {
      if (err) {
        return cb(err);
      }
      found.push(first);
      return doc.createRelationshipTo(self, kindOfRelationship, attributes, function(err, second) {
        if (err) {
          return cb(err);
        }
        found.push(second);
        if (typeof cb === 'function') {
          return cb(err, found);
        }
      });
    });
  };
  Document.prototype.queryGraph = function(chypherQuery, options, cb) {
    var doc, _ref;

    doc = this;
    _ref = processtools.sortOptionsAndCallback(options, cb), options = _ref.options, cb = _ref.cb;
    options.mongodbConnection = doc.db;
    return _queryGraphDB(chypherQuery, options, cb);
  };
  Document.prototype.queryRelationships = function(kindOfRelationship, options, cb) {
    var doc, id, _ref, _ref1, _ref2, _ref3, _ref4, _ref5;

    if (typeof options === 'string') {
      options = {
        query: options
      };
    }
    _ref = processtools.sortOptionsAndCallback(options, cb), options = _ref.options, cb = _ref.cb;
    if (kindOfRelationship == null) {
      kindOfRelationship = '*';
    }
    kindOfRelationship = /^[*:]{1}$/.test(kindOfRelationship) || !kindOfRelationship ? '' : ':' + kindOfRelationship;
    if ((_ref1 = options.direction) == null) {
      options.direction = 'both';
    }
    if ((_ref2 = options.action) == null) {
      options.action = "RETURN";
    }
    if ((_ref3 = options.processPart) == null) {
      options.processPart = "relation";
    }
    if ((_ref4 = options.endNode) == null) {
      options.endNode = "";
    }
    if (typeof endNode === 'object') {
      options.endNode = endNode.id;
    }
    if ((_ref5 = options.loadDocuments) == null) {
      options.loadDocuments = true;
    }
    doc = this;
    id = processtools.getObjectIDAsString(doc);
    return this.getNode(function(nodeErr, fromNode) {
      var cypher, _ref6;

      cypher = "START a = node(%(id)s)%(endNode)s\nMATCH (a)%(incoming)s[relation%(relation)s]%(outgoing)s(b)\n%(action)s %(processPart)s;";
      cypher = _s.sprintf(cypher, {
        id: fromNode.id,
        incoming: options.direction === 'incoming' ? '<-' : '-',
        outgoing: options.direction === 'outgoing' ? '->' : '-',
        relation: kindOfRelationship,
        action: options.action.toUpperCase(),
        processPart: options.processPart,
        endNode: options.endNode ? ", b = node(" + options.endNode + ")" : ''
      });
      if (options.query) {
        cypher = query;
      }
      if (options.dontExecute) {
        return cb({
          message: "`dontExecute` options is set",
          query: cypher,
          options: options
        }, null);
      } else {
        if ((_ref6 = options.mongodbConnection) == null) {
          options.mongodbConnection = doc.db;
        }
        return _queryGraphDB(cypher, options, cb);
      }
    });
  };
  Document.prototype.allRelationships = function(kindOfRelationship, cb) {
    return this.queryRelationships(kindOfRelationship, {
      direction: 'both'
    }, cb);
  };
  Document.prototype.incomingRelationships = function(kindOfRelationship, cb) {
    return this.queryRelationships(kindOfRelationship, {
      direction: 'incoming'
    }, cb);
  };
  Document.prototype.outgoingRelationships = function(kindOfRelationship, cb) {
    return this.queryRelationships(kindOfRelationship, {
      direction: 'outgoing'
    }, cb);
  };
  Document.prototype.removeRelationshipsTo = function(doc, kindOfRelationship, cb, direction) {
    var from;

    if (direction == null) {
      direction = 'outgoing';
    }
    from = this;
    return doc.getNode(function(nodeErr, endNode) {
      if (nodeErr) {
        return cb(nodeErr, endNode);
      }
      return from.queryRelationships(kindOfRelationship, {
        direction: direction,
        action: 'DELETE',
        endNode: endNode.id
      }, cb);
    });
  };
  Document.prototype.removeRelationshipsFrom = function(doc, kindOfRelationship, cb, direction) {
    if (direction == null) {
      direction = 'incoming';
    }
    return this.removeRelationshipsTo(doc, kindOfRelationship, cb, direction);
  };
  Document.prototype.removeRelationshipsBetween = function(doc, kindOfRelationship, cb, direction) {
    if (direction == null) {
      direction = 'both';
    }
    return this.removeRelationshipsTo(doc, kindOfRelationship, cb, direction);
  };
  return Document.prototype.removeRelationships = function(kindOfRelationship, cb, direction) {
    if (direction == null) {
      direction = 'both';
    }
    return this.queryRelationships(kindOfRelationship, {
      action: 'DELETE',
      direction: direction
    }, cb);
  };
};
