<!DOCTYPE html><html lang="en"><head><title>src/extendNode</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="src/extendNode"><meta name="groc-project-path" content="src/extendNode.coffee"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path">src/extendNode.coffee</div></div><div id="document"><div class="segment"><div class="comments"><div class="wrapper"><h3 id="extend-neo4j">Extend Neo4j</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="c1">#</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>This models extends the Node object of the neo4j module with:
* get the collectionname and _if of the mongodb document
* load the corresponding document from mongodb</p></div></div><div class="code"><div class="wrapper"><span class="nv">processtools = </span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;./processtools&#39;</span><span class="p">)</span>

<span class="nv">module.exports = </span><span class="nf">(globalOptions) -&gt;</span>

  <span class="nv">mongoose = </span><span class="nx">globalOptions</span><span class="p">.</span><span class="nx">mongoose</span>
  <span class="nv">graphdb  = </span><span class="nx">globalOptions</span><span class="p">.</span><span class="nx">neo4j</span>

  <span class="nx">processtools</span><span class="p">.</span><span class="nx">setNeo4j</span> <span class="nx">graphdb</span>

  <span class="c1">#### Adding document methods on node(s)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Is needed for prototyping</p></div></div><div class="code"><div class="wrapper">  <span class="nv">node = </span><span class="nx">graphdb</span><span class="p">.</span><span class="nx">createNode</span><span class="p">()</span>
  <span class="nv">Node = </span><span class="nx">node</span><span class="p">.</span><span class="nx">constructor</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Check that we don't override existing functions</p></div></div><div class="code"><div class="wrapper">  <span class="k">if</span> <span class="nx">globalOptions</span><span class="p">.</span><span class="nx">overrideProtypeFunctions</span> <span class="o">isnt</span> <span class="kc">true</span>
    <span class="k">for</span> <span class="nx">functionName</span> <span class="k">in</span> <span class="p">[</span> <span class="s">&#39;getDocument&#39;</span><span class="p">,</span> <span class="s">&#39;getMongoId&#39;</span><span class="p">,</span> <span class="s">&#39;getCollectionName&#39;</span> <span class="p">]</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s">&quot;Will not override neo4j::Node.prototype.</span><span class="si">#{</span><span class="nx">functionName</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span> <span class="k">unless</span> <span class="k">typeof</span> <span class="nx">node</span><span class="p">.</span><span class="nx">constructor</span><span class="o">::</span><span class="p">[</span><span class="nx">functionName</span><span class="p">]</span> <span class="o">is</span> <span class="s">&#39;undefined&#39;</span>

  <span class="c1">#### Loads corresponding document from given node object</span>
  <span class="nv">_loadDocumentFromNode = </span><span class="nf">(node, cb) -&gt;</span>
    <span class="k">return</span> <span class="nx">cb</span><span class="p">(</span><span class="s">&quot;No node object given&quot;</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="k">unless</span> <span class="nx">node</span><span class="o">?</span><span class="p">.</span><span class="nx">_data</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span>
    <span class="nv">_id = </span> <span class="k">new</span> <span class="nx">processtools</span><span class="p">.</span><span class="nx">getObjectIdFromString</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">getMongoId</span><span class="p">())</span>
    <span class="nv">collectionName = </span><span class="nx">node</span><span class="p">.</span><span class="nx">getCollectionName</span><span class="p">()</span>
    <span class="nx">cb</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s">&quot;No cb given&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">))</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nx">cb</span> <span class="o">isnt</span> <span class="s">&#39;function&#39;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>we need to query the collection natively here
TODO: find a more elegant way to access models instead of needing the "registerModels" way...</p></div></div><div class="code"><div class="wrapper">    <span class="nv">collection = </span><span class="nx">processtools</span><span class="p">.</span><span class="nx">getCollectionByCollectionName</span><span class="p">(</span><span class="nx">collectionName</span><span class="p">,</span> <span class="nx">mongoose</span><span class="p">)</span>
    <span class="nx">collection</span><span class="p">.</span><span class="nx">findOne</span> <span class="p">{</span> <span class="nv">_id: </span><span class="nx">_id</span> <span class="p">},</span> <span class="nx">cb</span>

  <span class="c1">#### Loads corresponding document from given neo4j url </span>
  <span class="nv">_loadDocumentFromNodeUrl = </span><span class="nf">(url, cb) -&gt;</span>
    <span class="nx">graphdb</span><span class="p">.</span><span class="nx">getNode</span> <span class="nx">url</span><span class="p">,</span> <span class="nf">(err, node) -&gt;</span>
      <span class="k">return</span> <span class="nx">cb</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">node</span><span class="p">)</span> <span class="k">if</span> <span class="nx">err</span> 
      <span class="nx">_loadDocumentFromNode</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span>

  <span class="c1">#### Returns the name of the collection from indexed url or from stored key/value</span>
  <span class="nv">Node::getCollectionName = </span><span class="nf">-&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>try to extract collection from url (indexed namespace)
TODO: better could be via parent document if exists
indexed: 'http://localhost:7474/db/data/index/node/people/_id/516123bcc86e28485e000007/755' }</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@_data</span><span class="o">?</span><span class="p">.</span><span class="nx">indexed</span><span class="o">?</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/\/data\/index\/node\/(.+?)\//</span><span class="p">)</span><span class="o">?</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">||</span> <span class="nx">@_data</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">_collection</span>

  <span class="c1">#### Returns the mongodb document _id from stored key/value</span>
  <span class="nv">Node::getMongoId = </span><span class="nf">-&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>TODO: sometimes node doen't include the data -> would need extra call
e.g.: _data: { self: 'http://localhost:7474/db/data/node/X' } }</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@_data</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">_id</span><span class="c1"># or null</span>

  <span class="c1">#### Loads the node&#39;s corresponding document from mongodb</span>
  <span class="nv">Node::getDocument = </span><span class="nf">(cb) -&gt;</span>
    <span class="k">return</span> <span class="nx">cb</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">@</span><span class="nb">document</span><span class="p">)</span> <span class="k">if</span> <span class="nx">@</span><span class="nb">document</span> <span class="o">and</span> <span class="k">typeof</span> <span class="nx">cb</span> <span class="o">is</span> <span class="s">&#39;function&#39;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Native mongodb call, so we need the objectid as object</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="nx">@_data</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">_id</span>
      <span class="nx">_loadDocumentFromNode</span> <span class="nx">@</span><span class="p">,</span> <span class="nx">cb</span>
    <span class="k">else</span>
      <span class="nx">_loadDocumentFromNodeUrl</span> <span class="nx">@_data</span><span class="o">?</span><span class="p">.</span><span class="nx">self</span><span class="p">,</span> <span class="nx">cb</span></div></div></div></div></body></html>