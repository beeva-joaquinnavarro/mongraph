<!DOCTYPE html><html lang="en"><head><title>src/processtools</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="src/processtools"><meta name="groc-project-path" content="src/processtools.coffee"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path">src/processtools.coffee</div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="nv">ObjectId = </span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;bson&#39;</span><span class="p">).</span><span class="nx">ObjectID</span>
<span class="nv">Join = </span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;join&#39;</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>private
dbhandler</p></div></div><div class="code"><div class="wrapper"><span class="nv">mongoose = </span><span class="kc">null</span>
<span class="nv">neo4j    = </span><span class="kc">null</span>

<span class="nv">setMongoose = </span><span class="nf">(mongooseHandler) -&gt;</span> <span class="nv">mongoose = </span><span class="nx">mongooseHandler</span>
<span class="nv">getMongoose = </span><span class="nf">-&gt;</span> <span class="nx">mongoose</span>

<span class="nv">setNeo4j = </span><span class="nf">(neo4jHandler) -&gt;</span> <span class="nv">neo4j = </span><span class="nx">neo4jHandler</span>
<span class="nv">getNeo4j = </span><span class="nf">-&gt;</span> <span class="nx">neo4j</span>

<span class="nv">sortOptionsAndCallback = </span><span class="nf">(options, cb) -&gt;</span>
  <span class="k">if</span> <span class="k">typeof</span> <span class="nx">options</span> <span class="o">is</span> <span class="s">&#39;function&#39;</span>
    <span class="p">{</span> <span class="nv">options: </span><span class="p">{},</span> <span class="nv">cb: </span><span class="nx">options</span> <span class="p">}</span>
  <span class="k">else</span>
    <span class="p">{</span> <span class="nv">options: </span><span class="nx">options</span> <span class="o">or</span> <span class="p">{},</span> <span class="nv">cb: </span><span class="nx">cb</span> <span class="p">}</span>

<span class="nv">sortAttributesAndCallback = </span><span class="nf">(attributes, cb) -&gt;</span>
  <span class="p">{</span><span class="nx">options</span><span class="p">,</span><span class="nx">cb</span><span class="p">}</span> <span class="o">=</span> <span class="nx">sortOptionsAndCallback</span><span class="p">(</span><span class="nx">attributes</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span>
  <span class="p">{</span> <span class="nv">attributes: </span><span class="nx">options</span><span class="p">,</span> <span class="nv">cb: </span><span class="nx">cb</span><span class="p">}</span>

<span class="nv">sortJoins = </span><span class="nf">(args) -&gt;</span>
  <span class="nv">args = </span><span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span>
  <span class="nv">returns = </span><span class="p">{</span> <span class="nv">errors: </span><span class="p">[]</span> <span class="p">,</span> <span class="nv">result: </span><span class="p">[]</span> <span class="p">}</span>
  <span class="k">for</span> <span class="nx">arg</span> <span class="k">in</span> <span class="nx">args</span>
    <span class="nx">returns</span><span class="p">.</span><span class="nx">errors</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">arg</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="nx">arg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nx">returns</span><span class="p">.</span><span class="nx">errors</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">arg</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">if</span> <span class="nx">arg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
  <span class="nv">returns.errors = </span><span class="k">if</span> <span class="nx">returns</span><span class="p">.</span><span class="nx">errors</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">then</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">returns</span><span class="p">.</span><span class="nx">errors</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s">&quot;, &quot;</span><span class="p">))</span> <span class="k">else</span> <span class="kc">null</span> 
  <span class="nv">returns.result = </span><span class="k">if</span> <span class="nx">returns</span><span class="p">.</span><span class="nx">result</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">then</span> <span class="nx">returns</span><span class="p">.</span><span class="nx">result</span> <span class="k">else</span> <span class="kc">null</span>
  <span class="nx">returns</span>

<span class="nv">sortTypeOfRelationshipAndOptionsAndCallback = </span><span class="nf">(r, o, c) -&gt;</span>
  <span class="nv">returns = </span><span class="p">{</span> <span class="nv">typeOfRelationship: </span><span class="s">&#39;*&#39;</span><span class="p">,</span> <span class="nv">options: </span><span class="p">{},</span> <span class="nv">cb: </span><span class="kc">null</span> <span class="p">}</span>
  <span class="k">if</span> <span class="k">typeof</span> <span class="nx">r</span> <span class="o">is</span> <span class="s">&#39;string&#39;</span>
    <span class="nv">returns.typeOfRelationship = </span><span class="nx">r</span>
    <span class="p">{</span><span class="nx">options</span><span class="p">,</span><span class="nx">cb</span><span class="p">}</span> <span class="o">=</span> <span class="nx">sortOptionsAndCallback</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span><span class="nx">c</span><span class="p">)</span>
    <span class="nv">returns.options = </span><span class="nx">options</span>
    <span class="nv">returns.cb = </span><span class="nx">cb</span>
  <span class="k">else</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nx">r</span> <span class="o">is</span> <span class="s">&#39;object&#39;</span>
    <span class="p">{</span><span class="nx">options</span><span class="p">,</span><span class="nx">cb</span><span class="p">}</span> <span class="o">=</span> <span class="nx">sortOptionsAndCallback</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span><span class="nx">o</span><span class="p">)</span>
    <span class="nv">returns.options = </span><span class="nx">options</span>
    <span class="nv">returns.cb = </span><span class="nx">cb</span>
  <span class="k">else</span>
    <span class="nv">returns.cb = </span><span class="nx">r</span>
  <span class="nx">returns</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>extract the constructor name as string</p></div></div><div class="code"><div class="wrapper"><span class="nv">constructorNameOf = </span><span class="nf">(f) -&gt;</span>
  <span class="nx">f</span><span class="o">?</span><span class="p">.</span><span class="nx">constructor</span><span class="o">?</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">match</span><span class="p">(</span><span class="sr">/function\s+(.+?)\(/</span><span class="p">)</span><span class="o">?</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">trim</span><span class="p">()</span> <span class="o">||</span> <span class="kc">null</span>

<span class="nv">extractCollectionAndId = </span><span class="nf">(s) -&gt;</span>
  <span class="p">{</span> <span class="nv">collectionName: </span><span class="nx">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nv">_id: </span><span class="nx">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">}</span> <span class="k">if</span> <span class="p">(</span><span class="nv">parts = </span><span class="nx">s</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s">&quot;:&quot;</span><span class="p">))</span>

<span class="nv">_buildQueryFromIdAndCondition = </span><span class="nf">(_id_s, condition) -&gt;</span>
  <span class="k">if</span> <span class="nx">_id_s</span><span class="o">?</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">is</span> <span class="nb">Array</span>
    <span class="nv">idCondition = </span><span class="p">{</span> <span class="nv">_id: </span><span class="p">{</span> <span class="nv">$in: </span><span class="nx">_id</span> <span class="p">}</span> <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="nx">_id_s</span>
    <span class="nv">idCondition = </span><span class="p">{</span><span class="err">Â </span><span class="nv">_id: </span><span class="nb">String</span><span class="p">(</span><span class="nx">_id_s</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">else</span>
    <span class="k">return</span> <span class="p">{}</span>
  <span class="k">if</span> <span class="k">typeof</span> <span class="nx">condition</span> <span class="o">is</span> <span class="s">&#39;object&#39;</span> <span class="o">and</span> <span class="nx">condition</span> <span class="o">and</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">condition</span><span class="p">)</span><span class="o">?</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">then</span> <span class="p">{</span> <span class="nv">$and: </span><span class="p">[</span> <span class="nx">idCondition</span><span class="p">,</span> <span class="nx">condition</span> <span class="p">]</span> <span class="p">}</span> <span class="k">else</span> <span class="nx">idCondition</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>extract id as string from a mixed argument</p></div></div><div class="code"><div class="wrapper"><span class="nv">getObjectIDAsString = </span><span class="nf">(obj) -&gt;</span>
  <span class="k">if</span> <span class="k">typeof</span> <span class="nx">obj</span> <span class="o">is</span> <span class="s">&#39;string&#39;</span>
    <span class="nx">obj</span>
  <span class="k">else</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nx">obj</span> <span class="o">is</span> <span class="s">&#39;object&#39;</span>
    <span class="p">(</span><span class="nb">String</span><span class="p">)</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">_id</span> <span class="o">or</span> <span class="nx">obj</span>
  <span class="k">else</span>
    <span class="s">&#39;&#39;</span>

<span class="nv">getObjectIdFromString = </span><span class="nf">(s) -&gt;</span>
  <span class="k">new</span> <span class="nx">ObjectId</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>extract id's from a mixed type</p></div></div><div class="code"><div class="wrapper"><span class="nv">getObjectIDsAsArray = </span><span class="nf">(mixed) -&gt;</span>
  <span class="nv">ids = </span><span class="p">[]</span>
  <span class="k">if</span> <span class="nx">mixed</span><span class="o">?</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">==</span> <span class="nb">Array</span>
    <span class="k">for</span> <span class="nx">item</span> <span class="k">in</span> <span class="nx">mixed</span>
      <span class="nx">ids</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="k">if</span> <span class="nv">id = </span><span class="nx">getObjectIDAsString</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span>
  <span class="k">else</span>
    <span class="nv">ids = </span><span class="p">[</span> <span class="nx">getObjectIDAsString</span><span class="p">(</span><span class="nx">mixed</span><span class="p">)</span> <span class="p">]</span>
  <span class="nx">ids</span>

<span class="nv">getModelByCollectionName = </span><span class="nf">(collectionName, mongoose) -&gt;</span>
  <span class="k">if</span> <span class="nx">constructorNameOf</span><span class="p">(</span><span class="nx">mongoose</span><span class="p">)</span> <span class="o">is</span> <span class="s">&#39;Mongoose&#39;</span>
    <span class="nv">models = </span><span class="nx">mongoose</span><span class="p">.</span><span class="nx">models</span>
  <span class="k">else</span> <span class="k">unless</span> <span class="nx">mongoose</span>
    <span class="k">return</span> <span class="kc">null</span>
  <span class="k">else</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>we assume that we have mongoose.models here</p></div></div><div class="code"><div class="wrapper">    <span class="nv">models = </span><span class="nx">mongoose</span>
  <span class="nv">name = </span><span class="kc">null</span>
  <span class="k">for</span> <span class="nx">nameOfModel</span><span class="p">,</span> <span class="nx">i</span> <span class="k">of</span> <span class="nx">models</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>iterate through models and find the corresponding collection and modelname</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="nx">collectionName</span> <span class="o">is</span> <span class="nx">models</span><span class="p">[</span><span class="nx">nameOfModel</span><span class="p">].</span><span class="nx">collection</span><span class="p">.</span><span class="nx">name</span>
      <span class="nv">name = </span><span class="nx">models</span><span class="p">[</span><span class="nx">nameOfModel</span><span class="p">].</span><span class="nx">modelName</span>
  <span class="nx">name</span>

<span class="nv">getCollectionByCollectionName = </span><span class="nf">(collectionName, mongoose) -&gt;</span>
  <span class="nv">modelName = </span><span class="nx">getModelByCollectionName</span><span class="p">(</span><span class="nx">collectionName</span><span class="p">,</span> <span class="nx">mongoose</span><span class="p">)</span>
  <span class="nx">mongoose</span><span class="p">.</span><span class="nx">models</span><span class="p">[</span><span class="nx">modelName</span><span class="p">]</span> <span class="o">or</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">connections</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="nx">collectionName</span><span class="p">)</span> <span class="o">or</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="nx">collectionName</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="iterates-through-the-neo4js-resultset-and-attach-documents-from-mongodb">Iterates through the neo4j's resultset and attach documents from mongodb</h1></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="c1">#</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Currently we having three different of expected Objects: Node, Relationship and Path
TODO: maybe split up to submethods for each object type
TODO: reduce mongodb queries by sorting ids to collection(s) and query them once per collection with $in : [ ids... ] ...</p></div></div><div class="code"><div class="wrapper"><span class="nv">populateResultWithDocuments = </span><span class="nf">(results, options, cb) -&gt;</span>
  <span class="p">{</span><span class="nx">options</span><span class="p">,</span> <span class="nx">cb</span><span class="p">}</span> <span class="o">=</span> <span class="nx">sortOptionsAndCallback</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span><span class="nx">cb</span><span class="p">)</span>
  
  <span class="nx">options</span><span class="p">.</span><span class="nx">count</span> <span class="o">?=</span> <span class="kc">false</span>
  <span class="nx">options</span><span class="p">.</span><span class="nx">restructure</span> <span class="o">?=</span> <span class="kc">true</span> <span class="c1"># do some useful restructure</span>
  <span class="nx">options</span><span class="p">.</span><span class="nx">referenceDocumentID</span> <span class="o">?=</span> <span class="kc">null</span> <span class="c1"># document which is our base document, import for where queries</span>
  <span class="nv">options.referenceDocumentID = </span><span class="nb">String</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">referenceDocumentID</span><span class="p">)</span> <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">referenceDocumentID</span>
  <span class="nx">options</span><span class="p">.</span><span class="nx">relationships</span> <span class="o">?=</span> <span class="p">{}</span>
  <span class="nx">options</span><span class="p">.</span><span class="nx">collection</span> <span class="o">?=</span> <span class="kc">null</span> <span class="c1"># distinct collection</span>
  <span class="nx">options</span><span class="p">.</span><span class="nx">where</span><span class="o">?</span><span class="p">.</span><span class="nb">document</span> <span class="o">?=</span> <span class="kc">null</span> <span class="c1"># query documents</span>
  <span class="nx">options</span><span class="p">.</span><span class="nx">debug</span><span class="o">?</span><span class="p">.</span><span class="nx">where</span> <span class="o">?=</span> <span class="p">[]</span>
  <span class="nx">options</span><span class="p">.</span><span class="nx">stripEmptyItems</span> <span class="o">?=</span> <span class="kc">true</span>
  

  <span class="k">unless</span> <span class="nx">results</span> <span class="k">instanceof</span> <span class="nb">Object</span>
    <span class="k">return</span> <span class="nx">cb</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s">&#39;Object is needed for processing&#39;</span><span class="p">),</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span>
  <span class="k">else</span> <span class="k">unless</span> <span class="nx">results</span> <span class="k">instanceof</span> <span class="nb">Array</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>put in array to iterate</p></div></div><div class="code"><div class="wrapper">    <span class="nv">results = </span><span class="p">[</span> <span class="nx">results</span> <span class="p">]</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Finally called when <em>all</em> documents are loaded and we can pass the result to cb</p></div></div><div class="code"><div class="wrapper">  <span class="nv">final = </span><span class="nf">(err) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>[ null, {...}, null, ..., {...}, {...} ] ->  [ {...}, ..., {...}, {...} ]
return only path if we have a path here and the option is set to restructre
TODO: find a more elegant solution than this</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">restructure</span> <span class="o">and</span> <span class="nx">path</span><span class="o">?</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="nv">results = </span><span class="nx">path</span>
    <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">stripEmptyItems</span> <span class="o">and</span> <span class="nx">results</span><span class="o">?</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="nv">cleanedResults = </span><span class="p">[]</span>
      <span class="k">for</span> <span class="nx">result</span> <span class="k">in</span> <span class="nx">results</span>
        <span class="nx">cleanedResults</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="k">if</span> <span class="nx">result</span><span class="o">?</span>
      <span class="nx">cb</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">cleanedResults</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nx">cb</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">results</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>TODO: if distinct collection</p></div></div><div class="code"><div class="wrapper">  <span class="nv">mongoose = </span><span class="nx">getMongoose</span><span class="p">()</span>  <span class="c1"># get mongoose handler</span>
  <span class="nv">graphdb  = </span><span class="nx">getNeo4j</span><span class="p">()</span>     <span class="c1"># get neo4j handler</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>TODO: extend Path and Relationship objects (nit possible with prototyping here) </p></div></div><div class="code"><div class="wrapper">  <span class="nv">path = </span><span class="kc">null</span>

  <span class="nv">join = </span><span class="nx">Join</span><span class="p">.</span><span class="nx">create</span><span class="p">()</span>
  <span class="k">for</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">results</span>
    <span class="nx">do</span> <span class="nf">(result, i) -&gt;</span>
      </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="node">NODE</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="nx">constructorNameOf</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="o">is</span> <span class="s">&#39;Node&#39;</span> <span class="o">and</span> <span class="nx">result</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">collection</span> <span class="o">and</span> <span class="nx">result</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">_id</span> 
        <span class="nv">callback = </span><span class="nx">join</span><span class="p">.</span><span class="nx">add</span><span class="p">()</span>
        <span class="nv">isReferenceDocument = </span><span class="nx">options</span><span class="p">.</span><span class="nx">referenceDocumentID</span> <span class="o">is</span> <span class="nx">result</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">_id</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>skip if distinct collection if differ</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">collection</span> <span class="o">and</span> <span class="nx">options</span><span class="p">.</span><span class="nx">collection</span> <span class="o">isnt</span> <span class="nx">result</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">collection</span>
          <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">results</span><span class="p">)</span>
        <span class="k">else</span>
          <span class="nv">conditions = </span><span class="nx">_buildQueryFromIdAndCondition</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span> <span class="k">unless</span> <span class="nx">isReferenceDocument</span> <span class="k">then</span> <span class="nx">options</span><span class="p">.</span><span class="nx">where</span><span class="o">?</span><span class="p">.</span><span class="nb">document</span><span class="p">)</span>
          <span class="nx">options</span><span class="p">.</span><span class="nx">debug</span><span class="o">?</span><span class="p">.</span><span class="nx">where</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">conditions</span><span class="p">)</span>
          <span class="nv">collection = </span><span class="nx">getCollectionByCollectionName</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">collection</span><span class="p">,</span> <span class="nx">mongoose</span><span class="p">)</span>
          <span class="nx">collection</span><span class="p">.</span><span class="nx">findOne</span> <span class="nx">conditions</span><span class="p">,</span> <span class="nf">(err, foundDocument) -&gt;</span>
            <span class="nx">results</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nb">document</span> <span class="o">=</span> <span class="nx">foundDocument</span>
            <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">results</span><span class="p">)</span>
      </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="relationship">RELATIONSHIP</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">      <span class="k">else</span> <span class="k">if</span> <span class="nx">constructorNameOf</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="o">is</span> <span class="s">&#39;Relationship&#39;</span> <span class="o">and</span> <span class="nx">result</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">_from</span> <span class="o">and</span> <span class="nx">result</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">_to</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>TODO: trigger updateRelationships for both sides if query was about and option is set to</p></div></div><div class="code"><div class="wrapper">        <span class="nv">callback = </span><span class="nx">join</span><span class="p">.</span><span class="nx">add</span><span class="p">()</span>
        <span class="nv">fromAndToJoin = </span><span class="nx">Join</span><span class="p">.</span><span class="nx">create</span><span class="p">()</span>
        <span class="k">for</span> <span class="nx">point</span> <span class="k">in</span> <span class="p">[</span> <span class="s">&#39;from&#39;</span><span class="p">,</span> <span class="s">&#39;to&#39;</span><span class="p">]</span>
          <span class="nv">intermediateCallback = </span><span class="nx">fromAndToJoin</span><span class="p">.</span><span class="nx">add</span><span class="p">()</span>
          <span class="nx">do</span> <span class="nf">(point, intermediateCallback) -&gt;</span>
            <span class="p">{</span><span class="nx">collectionName</span><span class="p">,</span><span class="nx">_id</span><span class="p">}</span> <span class="o">=</span> <span class="nx">extractCollectionAndId</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="s">&quot;_</span><span class="si">#{</span><span class="nx">point</span><span class="si">}</span><span class="s">&quot;</span><span class="p">])</span>
            <span class="nv">isReferenceDocument = </span><span class="nx">options</span><span class="p">.</span><span class="nx">referenceDocumentID</span> <span class="o">is</span> <span class="nx">_id</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>do we have a distinct collection and this records is from another collection? skip if so</p></div></div><div class="code"><div class="wrapper">            <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">collection</span> <span class="o">and</span> <span class="nx">options</span><span class="p">.</span><span class="nx">collection</span> <span class="o">isnt</span> <span class="nx">collectionName</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">isReferenceDocument</span> </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>remove relationship from result</p></div></div><div class="code"><div class="wrapper">              <span class="nx">results</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">null</span>
              <span class="nx">intermediateCallback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="kc">null</span><span class="p">)</span> <span class="c1">#  results will be taken directly from results[i]</span>
            <span class="k">else</span>
              <span class="nv">conditions = </span><span class="nx">_buildQueryFromIdAndCondition</span><span class="p">(</span><span class="nx">_id</span><span class="p">,</span> <span class="k">unless</span> <span class="nx">isReferenceDocument</span> <span class="k">then</span> <span class="nx">options</span><span class="p">.</span><span class="nx">where</span><span class="o">?</span><span class="p">.</span><span class="nb">document</span><span class="p">)</span>
              <span class="nx">options</span><span class="p">.</span><span class="nx">debug</span><span class="o">?</span><span class="p">.</span><span class="nx">where</span><span class="o">?</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">conditions</span><span class="p">)</span>
              <span class="nv">collection = </span><span class="nx">getCollectionByCollectionName</span><span class="p">(</span><span class="nx">collectionName</span><span class="p">,</span> <span class="nx">mongoose</span><span class="p">)</span>
              <span class="nx">collection</span><span class="p">.</span><span class="nx">findOne</span> <span class="nx">conditions</span><span class="p">,</span> <span class="nf">(err, foundDocument) -&gt;</span>
                <span class="k">if</span> <span class="nx">foundDocument</span> <span class="o">and</span> <span class="nx">results</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
                  <span class="nx">results</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">point</span><span class="p">]</span> <span class="o">=</span> <span class="nx">foundDocument</span>
                <span class="k">else</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>remove relationship from result</p></div></div><div class="code"><div class="wrapper">                  <span class="nx">results</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">null</span>
                <span class="nx">intermediateCallback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="kc">null</span><span class="p">)</span> <span class="c1"># results will be taken directly from results[i]</span>
        <span class="nx">fromAndToJoin</span><span class="p">.</span><span class="nx">when</span> <span class="nf">-&gt;</span>
          <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="path">PATH</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">      <span class="k">else</span> <span class="k">if</span> <span class="nx">constructorNameOf</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="o">is</span> <span class="s">&#39;Path&#39;</span> <span class="o">or</span> <span class="nx">constructorNameOf</span><span class="p">(</span><span class="nx">result</span><span class="p">[</span><span class="nx">options</span><span class="p">.</span><span class="nx">processPart</span><span class="p">])</span> <span class="o">is</span> <span class="s">&#39;Path&#39;</span> <span class="o">or</span>  <span class="nx">constructorNameOf</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">path</span><span class="p">)</span> <span class="o">is</span> <span class="s">&#39;Path&#39;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Define an object identifier for processPart</p></div></div><div class="code"><div class="wrapper">        <span class="nv">_p = </span><span class="nx">result</span><span class="p">[</span><span class="nx">options</span><span class="p">.</span><span class="nx">processPart</span><span class="p">]</span> <span class="o">||</span> <span class="nx">result</span><span class="p">.</span><span class="nx">path</span> <span class="o">||</span> <span class="nx">result</span>
        <span class="nx">results</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nv">path = </span><span class="nb">Array</span><span class="p">(</span><span class="nx">_p</span><span class="p">.</span><span class="nx">_nodes</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
        <span class="nv">path = </span><span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">restructure</span> <span class="k">then</span> <span class="nb">Array</span><span class="p">(</span><span class="nx">_p</span><span class="p">.</span><span class="nx">_nodes</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
        <span class="k">for</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">k</span> <span class="k">in</span> <span class="nx">_p</span><span class="p">.</span><span class="nx">_nodes</span>
          <span class="k">if</span> <span class="nx">node</span><span class="p">.</span><span class="nx">_data</span><span class="o">?</span><span class="p">.</span><span class="nx">self</span>
            <span class="nv">callback = </span><span class="nx">join</span><span class="p">.</span><span class="nx">add</span><span class="p">()</span>
            <span class="nx">do</span> <span class="nf">(k, callback) -&gt;</span>
              <span class="nx">graphdb</span><span class="p">.</span><span class="nx">getNode</span> <span class="nx">node</span><span class="p">.</span><span class="nx">_data</span><span class="p">.</span><span class="nx">self</span><span class="p">,</span> <span class="nf">(err, foundNode) -&gt;</span>
                <span class="k">if</span> <span class="nx">foundNode</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">_id</span>
                  <span class="nv">isReferenceDocument = </span><span class="nx">options</span><span class="p">.</span><span class="nx">referenceDocumentID</span> <span class="o">is</span> <span class="nx">foundNode</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">_id</span>
                  <span class="nv">collectionName = </span><span class="nx">foundNode</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">collection</span>
                  <span class="nv">_id = </span><span class="nx">foundNode</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">_id</span>
                  <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">collection</span> <span class="o">and</span> <span class="nx">options</span><span class="p">.</span><span class="nx">collection</span> <span class="o">isnt</span> <span class="nx">collectionName</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">isReferenceDocument</span> 
                    <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">path</span> <span class="o">||</span> <span class="nx">results</span><span class="p">)</span>
                  <span class="k">else</span>
                    <span class="nv">conditions = </span><span class="nx">_buildQueryFromIdAndCondition</span><span class="p">(</span><span class="nx">_id</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">where</span><span class="o">?</span><span class="p">.</span><span class="nb">document</span><span class="p">)</span>
                    <span class="nx">options</span><span class="p">.</span><span class="nx">debug</span><span class="o">?</span><span class="p">.</span><span class="nx">where</span><span class="o">?</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">conditions</span><span class="p">)</span>
                    <span class="nv">collection = </span><span class="nx">getCollectionByCollectionName</span><span class="p">(</span><span class="nx">collectionName</span><span class="p">,</span> <span class="nx">mongoose</span><span class="p">)</span>
                    <span class="nx">collection</span><span class="p">.</span><span class="nx">findOne</span> <span class="nx">conditions</span><span class="p">,</span> <span class="nf">(err, foundDocument) -&gt;</span>
                      <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">restructure</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>just push the documents to the result and leave everything else away</p></div></div><div class="code"><div class="wrapper">                        <span class="nx">path</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">foundDocument</span>
                      <span class="k">else</span>
                        <span class="nx">results</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">path</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">foundDocument</span>
                      <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">path</span> <span class="o">||</span> <span class="nx">results</span><span class="p">)</span>
                <span class="k">else</span>
                  <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">restructure</span>
                    <span class="nx">path</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="kc">null</span>
                  <span class="k">else</span>
                    <span class="nx">results</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">path</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="kc">null</span>
                  <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">path</span> <span class="o">||</span> <span class="nx">results</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="nx">final</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s">&quot;Could not detect given result type&quot;</span><span class="p">),</span><span class="kc">null</span><span class="p">)</span>
  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="if-all-callbacks-are-fulfilled">If all callbacks are fulfilled</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="nx">join</span><span class="p">.</span><span class="nx">when</span> <span class="nf">-&gt;</span>
    <span class="p">{</span><span class="nx">error</span><span class="p">,</span><span class="nx">result</span><span class="p">}</span> <span class="o">=</span> <span class="nx">sortJoins</span><span class="p">(</span><span class="nx">arguments</span><span class="p">)</span>
    <span class="nx">final</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="kc">null</span><span class="p">)</span>
<span class="nv">module.exports = </span><span class="p">{</span><span class="nx">populateResultWithDocuments</span><span class="p">,</span> <span class="nx">getObjectIDAsString</span><span class="p">,</span> <span class="nx">getObjectIDsAsArray</span><span class="p">,</span> <span class="nx">constructorNameOf</span><span class="p">,</span> <span class="nx">getObjectIdFromString</span><span class="p">,</span> <span class="nx">sortOptionsAndCallback</span><span class="p">,</span> <span class="nx">sortAttributesAndCallback</span><span class="p">,</span> <span class="nx">sortTypeOfRelationshipAndOptionsAndCallback</span><span class="p">,</span> <span class="nx">getModelByCollectionName</span><span class="p">,</span> <span class="nx">getCollectionByCollectionName</span><span class="p">,</span> <span class="nx">setMongoose</span><span class="p">,</span> <span class="nx">setNeo4j</span><span class="p">,</span> <span class="nx">extractCollectionAndId</span><span class="p">,</span> <span class="nx">ObjectId</span><span class="p">}</span></div></div></div></div></body></html>