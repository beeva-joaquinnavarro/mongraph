<!DOCTYPE html><html lang="en"><head><title>src/extendDocument</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="src/extendDocument"><meta name="groc-project-path" content="src/extendDocument.coffee"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path">src/extendDocument.coffee</div></div><div id="document"><div class="segment"><div class="comments"><div class="wrapper"><h3 id="extend-document">Extend Document</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="c1">#</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>This models extends the mongodb/mongoose Document with:
* allows creating, deleting and querying all kind of incoming and outgoing relationships
* native queries on neo4j with option to load Documents by default
* connects each Document with corresponding Node in neo4j</p></div></div><div class="code"><div class="wrapper"><span class="c1">#</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>TODO: check that we always get Documents as mongoose models</p></div></div><div class="code"><div class="wrapper"><span class="nv">_s = </span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;underscore.string&#39;</span><span class="p">)</span>
<span class="nv">processtools = </span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;./processtools&#39;</span><span class="p">)</span>
<span class="nv">Join = </span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;join&#39;</span><span class="p">)</span>

<span class="nv">module.exports = </span><span class="nf">(globalOptions) -&gt;</span>

  <span class="nv">mongoose = </span><span class="nx">globalOptions</span><span class="p">.</span><span class="nx">mongoose</span>
  <span class="nv">graphdb  = </span><span class="nx">globalOptions</span><span class="p">.</span><span class="nx">neo4j</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Check that we don't override existing functions</p></div></div><div class="code"><div class="wrapper">  <span class="k">if</span> <span class="nx">globalOptions</span><span class="p">.</span><span class="nx">overrideProtoypeFunctions</span> <span class="o">isnt</span> <span class="kc">true</span>
    <span class="k">for</span> <span class="nx">functionName</span> <span class="k">in</span> <span class="p">[</span>
      <span class="s">&#39;applyGraphRelationships&#39;</span><span class="p">,</span>
      <span class="s">&#39;removeNode&#39;</span><span class="p">,</span>
      <span class="s">&#39;shortestPathTo&#39;</span><span class="p">,</span>
      <span class="s">&#39;allRelationshipsBetween&#39;</span><span class="p">,</span>
      <span class="s">&#39;incomingRelationshipsFrom&#39;</span><span class="p">,</span>
      <span class="s">&#39;outgoingRelationshipsTo&#39;</span><span class="p">,</span>
      <span class="s">&#39;removeRelationships&#39;</span><span class="p">,</span>
      <span class="s">&#39;removeRelationshipsBetween&#39;</span><span class="p">,</span>
      <span class="s">&#39;removeRelationshipsFrom&#39;</span><span class="p">,</span>
      <span class="s">&#39;removeRelationshipsTo&#39;</span><span class="p">,</span>
      <span class="s">&#39;outgoingRelationships&#39;</span><span class="p">,</span>
      <span class="s">&#39;incomingRelationships&#39;</span><span class="p">,</span>
      <span class="s">&#39;allRelationships&#39;</span><span class="p">,</span>
      <span class="s">&#39;queryRelationships&#39;</span><span class="p">,</span>
      <span class="s">&#39;queryGraph&#39;</span><span class="p">,</span>
      <span class="s">&#39;createRelationshipBetween&#39;</span><span class="p">,</span>
      <span class="s">&#39;createRelationshipFrom&#39;</span><span class="p">,</span>
      <span class="s">&#39;createRelationshipTo&#39;</span><span class="p">,</span>
      <span class="s">&#39;getNodeId&#39;</span><span class="p">,</span>
      <span class="s">&#39;findOrCreateCorrespondingNode&#39;</span><span class="p">,</span>
      <span class="s">&#39;findCorrespondingNode&#39;</span><span class="p">,</span>
      <span class="s">&#39;dataForNode&#39;</span><span class="p">,</span>
      <span class="s">&#39;indexGraph&#39;</span>
    <span class="p">]</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s">&quot;Will not override mongoose::Document.prototype.</span><span class="si">#{</span><span class="nx">functionName</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span> <span class="k">unless</span> <span class="k">typeof</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">Document</span><span class="o">::</span><span class="p">[</span><span class="nx">functionName</span><span class="p">]</span> <span class="o">is</span> <span class="s">&#39;undefined&#39;</span>

  <span class="nv">Document = </span><span class="nx">mongoose</span><span class="p">.</span><span class="nx">Document</span>

  <span class="nx">processtools</span><span class="p">.</span><span class="nx">setMongoose</span> <span class="nx">mongoose</span>

  <span class="nv">node = </span><span class="nx">graphdb</span><span class="p">.</span><span class="nx">createNode</span><span class="p">()</span>

  <span class="c1">#### Allows extended querying to the graphdb and loads found Documents</span>
  <span class="c1">#### (is used by many methods for loading incoming + outgoing relationships) </span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>@param typeOfRelationship = '*' (any relationship you can query with cypher, e.g. KNOW, LOVE|KNOW ...)
@param options = {}
(first value is default)
* direction (both|incoming|outgoing)
* action: (RETURN|DELETE|...) (all other actions wich can be used in cypher)
* processPart: (relationship|path|...) (depends on the result you expect from our query)
* loadDocuments: (true|false)
* endNode: '' (can be a node object or a nodeID)</p></div></div><div class="code"><div class="wrapper">  <span class="nv">Document::queryRelationships = </span><span class="nf">(typeOfRelationship, options, cb) -&gt;</span>
    <span class="k">return</span> <span class="nx">cb</span><span class="p">(</span><span class="nb">Error</span><span class="p">(</span><span class="s">&#39;No graphability enabled&#39;</span><span class="p">),</span> <span class="kc">null</span><span class="p">)</span> <span class="k">unless</span> <span class="nx">@schema</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;graphability&#39;</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>REMOVED: options can be a cypher query as string
options = { query: options } if typeof options is 'string'</p></div></div><div class="code"><div class="wrapper">    <span class="p">{</span><span class="nx">typeOfRelationship</span><span class="p">,</span><span class="nx">options</span><span class="p">,</span> <span class="nx">cb</span><span class="p">}</span> <span class="o">=</span> <span class="nx">processtools</span><span class="p">.</span><span class="nx">sortTypeOfRelationshipAndOptionsAndCallback</span><span class="p">(</span><span class="nx">typeOfRelationship</span><span class="p">,</span><span class="nx">options</span><span class="p">,</span><span class="nx">cb</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>build query from options</p></div></div><div class="code"><div class="wrapper">    <span class="nx">typeOfRelationship</span>          <span class="o">?=</span> <span class="s">&#39;*&#39;</span>
    <span class="nv">typeOfRelationship           = </span><span class="k">if</span> <span class="sr">/^[*:]{1}$/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">typeOfRelationship</span><span class="p">)</span> <span class="o">or</span> <span class="o">not</span> <span class="nx">typeOfRelationship</span> <span class="k">then</span> <span class="s">&#39;&#39;</span> <span class="k">else</span> <span class="s">&#39;:&#39;</span><span class="o">+</span><span class="nx">typeOfRelationship</span>
    <span class="nx">options</span><span class="p">.</span><span class="nx">direction</span>           <span class="o">?=</span> <span class="s">&#39;both&#39;</span>
    <span class="nx">options</span><span class="p">.</span><span class="nx">action</span>              <span class="o">?=</span> <span class="s">&#39;RETURN&#39;</span>
    <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">count</span> <span class="o">or</span> <span class="nx">options</span><span class="p">.</span><span class="nx">countDistinct</span>
      <span class="nv">options.count              = </span><span class="s">&#39;distinct &#39;</span><span class="o">+</span><span class="nx">options</span><span class="p">.</span><span class="nx">countDistinct</span> <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">countDistinct</span>
      <span class="nv">options.returnStatement    = </span><span class="s">&#39;count(&#39;</span><span class="o">+</span><span class="nx">options</span><span class="p">.</span><span class="nx">count</span><span class="o">+</span><span class="s">&#39;)&#39;</span> 
      <span class="nv">options.processPart        = </span><span class="s">&#39;count(&#39;</span><span class="o">+</span><span class="nx">options</span><span class="p">.</span><span class="nx">count</span><span class="o">+</span><span class="s">&#39;)&#39;</span> 
    <span class="nx">options</span><span class="p">.</span><span class="nx">processPart</span>         <span class="o">?=</span> <span class="s">&#39;r&#39;</span>
    <span class="nx">options</span><span class="p">.</span><span class="nx">returnStatement</span>     <span class="o">?=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">processPart</span>   
    <span class="nx">options</span><span class="p">.</span><span class="nx">referenceDocumentID</span> <span class="o">?=</span> <span class="nx">@_id</span> </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>endNode can be string or node object</p></div></div><div class="code"><div class="wrapper">    <span class="nx">options</span><span class="p">.</span><span class="nx">endNodeId</span>           <span class="o">?=</span> <span class="s">&#39;&#39;</span>
    <span class="nv">options.endNodeId            = </span><span class="nx">endNode</span><span class="p">.</span><span class="nx">id</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nx">endNode</span> <span class="o">is</span> <span class="s">&#39;object&#39;</span>
    <span class="nv">options.debug = </span><span class="p">{}</span> <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">debug</span> <span class="o">is</span> <span class="kc">true</span>
    <span class="nv">doc = </span><span class="nx">@</span>
    <span class="nv">id = </span><span class="nx">processtools</span><span class="p">.</span><span class="nx">getObjectIDAsString</span><span class="p">(</span><span class="nx">doc</span><span class="p">)</span>
    <span class="nx">@getNode</span> <span class="nf">(nodeErr, fromNode) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>if no node is found</p></div></div><div class="code"><div class="wrapper">      <span class="k">return</span> <span class="nx">cb</span><span class="p">(</span><span class="nx">nodeErr</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="k">if</span> <span class="nx">nodeErr</span>

      

      <span class="nv">cypher = </span><span class="s">&quot;&quot;&quot;</span>
<span class="s">                START a = node(%(id)s)%(endNodeId)s</span>
<span class="s">                MATCH (a)%(incoming)s[r%(relation)s]%(outgoing)s(b)</span>
<span class="s">                %(whereRelationship)s</span>
<span class="s">                %(action)s %(returnStatement)s;</span>
<span class="s">               &quot;&quot;&quot;</span>
      


      <span class="nv">cypher = </span><span class="nx">_s</span><span class="p">.</span><span class="nx">sprintf</span> <span class="nx">cypher</span><span class="p">,</span>
        <span class="nv">id: </span>                <span class="nx">fromNode</span><span class="p">.</span><span class="nx">id</span>
        <span class="nv">incoming: </span>          <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">direction</span> <span class="o">is</span> <span class="s">&#39;incoming&#39;</span> <span class="k">then</span> <span class="s">&#39;&lt;-&#39;</span> <span class="k">else</span> <span class="s">&#39;-&#39;</span>
        <span class="nv">outgoing: </span>          <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">direction</span> <span class="o">is</span> <span class="s">&#39;outgoing&#39;</span> <span class="k">then</span> <span class="s">&#39;-&gt;&#39;</span> <span class="k">else</span> <span class="s">&#39;-&#39;</span>
        <span class="nv">relation: </span>          <span class="nx">typeOfRelationship</span>
        <span class="nv">action: </span>            <span class="nx">options</span><span class="p">.</span><span class="nx">action</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">()</span>
        <span class="nv">returnStatement: </span>   <span class="nx">options</span><span class="p">.</span><span class="nx">returnStatement</span>
        <span class="nv">whereRelationship: </span> <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">where</span><span class="o">?</span><span class="p">.</span><span class="nx">relationship</span> <span class="k">then</span> <span class="s">&quot;WHERE </span><span class="si">#{</span><span class="nx">options</span><span class="p">.</span><span class="nx">where</span><span class="p">.</span><span class="nx">relationship</span><span class="si">}</span><span class="s">&quot;</span> <span class="k">else</span> <span class="s">&#39;&#39;</span>
        <span class="nv">endNodeId: </span>         <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">endNodeId</span> <span class="k">then</span> <span class="s">&quot;, b = node(</span><span class="si">#{</span><span class="nx">options</span><span class="p">.</span><span class="nx">endNodeId</span><span class="si">}</span><span class="s">)&quot;</span> <span class="k">else</span> <span class="s">&#39;&#39;</span>
      <span class="nx">options</span><span class="p">.</span><span class="nx">startNode</span>     <span class="o">?=</span> <span class="nx">fromNode</span><span class="p">.</span><span class="nx">id</span> <span class="c1"># for logging</span>
      </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>take query from options and discard build query</p></div></div><div class="code"><div class="wrapper">      <span class="nv">cypher = </span><span class="nx">options</span><span class="p">.</span><span class="nx">cypher</span> <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">cypher</span>
      <span class="nx">options</span><span class="p">.</span><span class="nx">debug</span><span class="o">?</span><span class="p">.</span><span class="nx">cypher</span> <span class="o">?=</span> <span class="p">[]</span>
      <span class="nx">options</span><span class="p">.</span><span class="nx">debug</span><span class="o">?</span><span class="p">.</span><span class="nx">cypher</span><span class="o">?</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">cypher</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">dontExecute</span>
        <span class="nx">cb</span><span class="p">(</span><span class="nb">Error</span><span class="p">(</span><span class="s">&quot;`options.dontExecute` is set to true...&quot;</span><span class="p">),</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="nx">_queryGraphDB</span><span class="p">(</span><span class="nx">cypher</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span>


  <span class="c1">#### Loads the equivalent node to this Document </span>
  <span class="nv">Document::findCorrespondingNode = </span><span class="nf">(options, cb) -&gt;</span>
    <span class="p">{</span><span class="nx">options</span><span class="p">,</span> <span class="nx">cb</span><span class="p">}</span> <span class="o">=</span> <span class="nx">processtools</span><span class="p">.</span><span class="nx">sortOptionsAndCallback</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span><span class="nx">cb</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">cb</span><span class="p">(</span><span class="nb">Error</span><span class="p">(</span><span class="s">&#39;No graphability enabled&#39;</span><span class="p">),</span> <span class="kc">null</span><span class="p">)</span> <span class="k">unless</span> <span class="nx">@schema</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;graphability&#39;</span><span class="p">)</span>
    <span class="nv">doc = </span><span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>you can force a reloading of a node
so you can ensure to get the latest existing node directly from db</p></div></div><div class="code"><div class="wrapper">    <span class="nx">options</span><span class="p">.</span><span class="nx">forceReload</span> <span class="o">?=</span> <span class="kc">false</span>

    <span class="k">return</span> <span class="nx">cb</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">_cached_node</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="k">if</span> <span class="nx">globalOptions</span><span class="p">.</span><span class="nx">cacheAttachedNodes</span> <span class="o">and</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">_cached_node</span> <span class="o">and</span> <span class="nx">options</span><span class="p">.</span><span class="nx">forceReload</span> <span class="o">isnt</span> <span class="kc">true</span>

    <span class="nv">collectionName = </span><span class="nx">doc</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">name</span>
    <span class="nv">id = </span><span class="nx">processtools</span><span class="p">.</span><span class="nx">getObjectIDAsString</span><span class="p">(</span><span class="nx">doc</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Difference between doCreateIfNotExists and forceCreation:</p></div></div><div class="code"><div class="wrapper">    <span class="c1">#</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ul>
<li>doCreateIfNotExists -> persist the node if no corresponding node exists</li>
<li>forceCreation -> forces to create a node</li>
</ul></div></div><div class="code"><div class="wrapper">    <span class="c1">#</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>@forceCreation: this is needed because mongoose marks each document as
doc.new = true (which is checked to prevent accidently creating orphaned nodes).
As long it is 'init' doc.new stays true, but we need that to complete the 'pre' 'save' hook
(see -> mongraphMongoosePlugin) </p></div></div><div class="code"><div class="wrapper">    <span class="nx">options</span><span class="p">.</span><span class="nx">doCreateIfNotExists</span> <span class="o">?=</span> <span class="kc">false</span>
    <span class="nx">options</span><span class="p">.</span><span class="nx">forceCreation</span> <span class="o">?=</span> <span class="kc">false</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Find equivalent node in graphdb</p></div></div><div class="code"><div class="wrapper">    </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>TODO: cache existing node</p></div></div><div class="code"><div class="wrapper">    
    <span class="nv">_processNode = </span><span class="nf">(node, doc, cb) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>store document data also als in node -> untested and not recommend
known issue: neo4j doesn't store deeper levels of nested objects...</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="nx">globalOptions</span><span class="p">.</span><span class="nx">storeDocumentInGraphDatabase</span>
        <span class="nv">node.data = </span><span class="nx">doc</span><span class="p">.</span><span class="nx">toObject</span><span class="p">(</span><span class="nx">globalOptions</span><span class="p">.</span><span class="nx">storeDocumentInGraphDatabase</span><span class="p">)</span>
        <span class="nx">node</span><span class="p">.</span><span class="nx">save</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>store node_id on document</p></div></div><div class="code"><div class="wrapper">      <span class="nv">doc._node_id = </span><span class="nx">node</span><span class="p">.</span><span class="nx">id</span>
      <span class="nv">doc._cached_node = </span><span class="nx">node</span> <span class="k">if</span> <span class="nx">globalOptions</span><span class="p">.</span><span class="nx">cacheAttachedNodes</span>
      <span class="nx">cb</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span>

    <span class="k">if</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">isNew</span> <span class="o">is</span> <span class="kc">true</span> <span class="o">and</span> <span class="nx">options</span><span class="p">.</span><span class="nx">forceCreation</span> <span class="o">isnt</span> <span class="kc">true</span>
      <span class="nx">cb</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s">&quot;Can&#39;t return a &#39;corresponding&#39; node of an unpersisted document&quot;</span><span class="p">),</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">_node_id</span>
      <span class="nx">graphdb</span><span class="p">.</span><span class="nx">getNodeById</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">_node_id</span><span class="p">,</span> <span class="nf">(errFound, node) -&gt;</span>
        <span class="k">if</span> <span class="nx">errFound</span>
          <span class="nx">cb</span><span class="p">(</span><span class="nx">errFound</span><span class="p">,</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span>
        <span class="k">else</span>
          <span class="nx">_processNode</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span><span class="nx">doc</span><span class="p">,</span><span class="nx">cb</span><span class="p">)</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">doCreateIfNotExists</span> <span class="o">or</span> <span class="nx">options</span><span class="p">.</span><span class="nx">forceCreation</span> <span class="o">is</span> <span class="kc">true</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>create a new one</p></div></div><div class="code"><div class="wrapper">      <span class="nv">node = </span><span class="nx">graphdb</span><span class="p">.</span><span class="nx">createNode</span><span class="p">(</span> <span class="nv">_id: </span><span class="nx">id</span><span class="p">,</span> <span class="nv">_collection: </span><span class="nx">collectionName</span> <span class="p">)</span>
      <span class="nx">node</span><span class="p">.</span><span class="nx">save</span> <span class="nf">(errSave, node) -&gt;</span>
        <span class="k">if</span> <span class="nx">errSave</span>
          <span class="nx">cb</span><span class="p">(</span><span class="nx">errSave</span><span class="p">,</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span>
        <span class="k">else</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>do index for better queries outside mongraph
e.g. people/_id/5178fb1b48c7a4ae24000001</p></div></div><div class="code"><div class="wrapper">          <span class="nx">node</span><span class="p">.</span><span class="nx">index</span><span class="p">(</span><span class="nx">collectionName</span><span class="p">,</span> <span class="s">&#39;_id&#39;</span><span class="p">,</span> <span class="nx">id</span><span class="p">)</span>
          <span class="nx">_processNode</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">doc</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> 
    <span class="k">else</span>
      <span class="nx">cb</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span>

  <span class="c1">#### Finds or create equivalent Node to this Document</span>
  <span class="nv">Document::findOrCreateCorrespondingNode = </span><span class="nf">(options, cb) -&gt;</span>
    <span class="p">{</span><span class="nx">options</span><span class="p">,</span> <span class="nx">cb</span><span class="p">}</span> <span class="o">=</span> <span class="nx">processtools</span><span class="p">.</span><span class="nx">sortOptionsAndCallback</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span><span class="nx">cb</span><span class="p">)</span>
    <span class="nx">@findCorrespondingNode</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span>
  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Recommend to use this method instead of <code>findOrCreateCorrespondingNode</code>
shortcutmethod -> findOrCreateCorrespondingNode</p></div></div><div class="code"><div class="wrapper">  <span class="nv">Document::getNode = </span><span class="nx">Document</span><span class="o">::</span><span class="nx">findOrCreateCorrespondingNode</span>


  <span class="c1">#### Finds and returns id of corresponding Node</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Faster, because it returns directly from document if stored (see -> mongraphMongoosePlugin)</p></div></div><div class="code"><div class="wrapper">  <span class="nv">Document::getNodeId = </span><span class="nf">(cb) -&gt;</span>
    <span class="k">if</span> <span class="nx">@_node_id</span>
      <span class="nx">cb</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">@_node_id</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nx">@getNode</span> <span class="nf">(err, node) -&gt;</span>
        <span class="nx">cb</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">node</span><span class="o">?</span><span class="p">.</span><span class="nx">id</span> <span class="o">||</span> <span class="kc">null</span><span class="p">)</span>

  <span class="c1">#### Creates a relationship from this Document to a given document</span>
  <span class="nv">Document::createRelationshipTo = </span><span class="nf">(doc, typeOfRelationship, attributes = {}, cb) -&gt;</span>
    <span class="p">{</span><span class="nx">attributes</span><span class="p">,</span><span class="nx">cb</span><span class="p">}</span> <span class="o">=</span> <span class="nx">processtools</span><span class="p">.</span><span class="nx">sortAttributesAndCallback</span><span class="p">(</span><span class="nx">attributes</span><span class="p">,</span><span class="nx">cb</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">cb</span><span class="p">(</span><span class="nb">Error</span><span class="p">(</span><span class="s">&#39;No graphability enabled&#39;</span><span class="p">),</span> <span class="kc">null</span><span class="p">)</span> <span class="k">unless</span> <span class="nx">@schema</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;graphability&#39;</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>assign cb + attribute arguments</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="k">typeof</span> <span class="nx">attributes</span> <span class="o">is</span> <span class="s">&#39;function&#39;</span>
      <span class="nv">cb = </span><span class="nx">attributes</span>
      <span class="nv">attributes = </span><span class="p">{}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Is needed to load the records from mongodb
TODO: Currently we have to store these information redundant because
otherwise we would have to request each side for it's represantive node
seperately to get the information wich namespace/collection the mongodb records is stored
-->  would increase requests to neo4j</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="nx">globalOptions</span><span class="p">.</span><span class="nx">relationships</span><span class="p">.</span><span class="nx">storeIDsInRelationship</span>
      <span class="nx">attributes</span><span class="p">.</span><span class="nx">_to</span>   <span class="o">?=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s">&quot;:&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="nb">String</span><span class="p">)</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">_id</span>
      <span class="nx">attributes</span><span class="p">.</span><span class="nx">_from</span> <span class="o">?=</span> <span class="nx">@constructor</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">name</span>    <span class="o">+</span> <span class="s">&quot;:&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="nb">String</span><span class="p">)</span> <span class="nx">@</span><span class="p">.</span><span class="nx">_id</span>
     
    <span class="k">if</span> <span class="nx">globalOptions</span><span class="p">.</span><span class="nx">relationships</span><span class="p">.</span><span class="nx">storeTimestamp</span>
      <span class="nx">attributes</span><span class="p">.</span><span class="nx">_created_at</span> <span class="o">?=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="o">/</span><span class="mi">1000</span><span class="p">)</span> </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Get both nodes: "from" node (this document) and "to" node (given as 1st argument)</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@findOrCreateCorrespondingNode</span> <span class="nf">(fromErr, from) -&gt;</span>
      <span class="nx">doc</span><span class="p">.</span><span class="nx">findOrCreateCorrespondingNode</span> <span class="nf">(toErr, to) -&gt;</span>
        <span class="k">if</span> <span class="nx">from</span> <span class="o">and</span> <span class="nx">to</span>
          <span class="nx">from</span><span class="p">.</span><span class="nx">createRelationshipTo</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">typeOfRelationship</span><span class="p">,</span> <span class="nx">attributes</span><span class="p">,</span> <span class="nf">(err, result) -&gt;</span>
            <span class="k">return</span> <span class="nx">cb</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="k">if</span> <span class="nx">err</span>
            <span class="nx">processtools</span><span class="p">.</span><span class="nx">populateResultWithDocuments</span> <span class="nx">result</span><span class="p">,</span> <span class="p">{},</span> <span class="nx">cb</span>
        <span class="k">else</span>
          <span class="nx">cb</span><span class="p">(</span><span class="nx">fromErr</span> <span class="o">or</span> <span class="nx">toErr</span><span class="p">,</span> <span class="kc">null</span><span class="p">)</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nx">cb</span> <span class="o">is</span> <span class="s">&#39;function&#39;</span>
  
  <span class="c1">#### Creates an incoming relationship from a given Documents to this Document</span>
  <span class="nv">Document::createRelationshipFrom = </span><span class="nf">(doc, typeOfRelationship, attributes = {}, cb) -&gt;</span>
    <span class="p">{</span><span class="nx">attributes</span><span class="p">,</span><span class="nx">cb</span><span class="p">}</span> <span class="o">=</span> <span class="nx">processtools</span><span class="p">.</span><span class="nx">sortAttributesAndCallback</span><span class="p">(</span><span class="nx">attributes</span><span class="p">,</span><span class="nx">cb</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>alternate directions: doc -> this</p></div></div><div class="code"><div class="wrapper">    <span class="nx">doc</span><span class="p">.</span><span class="nx">createRelationshipTo</span><span class="p">(</span><span class="nx">@</span><span class="p">,</span> <span class="nx">typeOfRelationship</span><span class="p">,</span> <span class="nx">attributes</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span>

  <span class="c1">#### Creates a bidrectional relationship between two Documents</span>
  <span class="nv">Document::createRelationshipBetween = </span><span class="nf">(doc, typeOfRelationship, attributes = {}, cb) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>both directions</p></div></div><div class="code"><div class="wrapper">    <span class="p">{</span><span class="nx">attributes</span><span class="p">,</span><span class="nx">cb</span><span class="p">}</span> <span class="o">=</span> <span class="nx">processtools</span><span class="p">.</span><span class="nx">sortAttributesAndCallback</span><span class="p">(</span><span class="nx">attributes</span><span class="p">,</span><span class="nx">cb</span><span class="p">)</span>
    <span class="nv">from = </span><span class="nx">@</span>
    <span class="nv">to = </span><span class="nx">doc</span>
    <span class="nx">from</span><span class="p">.</span><span class="nx">createRelationshipTo</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">typeOfRelationship</span><span class="p">,</span> <span class="nf">(err1) -&gt;</span> <span class="nx">to</span><span class="p">.</span><span class="nx">createRelationshipTo</span> <span class="nx">from</span><span class="p">,</span> <span class="nx">typeOfRelationship</span><span class="p">,</span> <span class="nf">(err2) -&gt;</span>
      <span class="nx">cb</span><span class="p">(</span><span class="nx">err1</span> <span class="o">||</span> <span class="nx">err2</span><span class="p">,</span> <span class="kc">null</span><span class="p">)</span>

  <span class="c1">#### Query the graphdb with cypher, current Document is not relevant for the query </span>
  <span class="nv">Document::queryGraph = </span><span class="nf">(chypherQuery, options, cb) -&gt;</span>
    <span class="p">{</span><span class="nx">options</span><span class="p">,</span> <span class="nx">cb</span><span class="p">}</span> <span class="o">=</span> <span class="nx">processtools</span><span class="p">.</span><span class="nx">sortOptionsAndCallback</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span><span class="nx">cb</span><span class="p">)</span>
    <span class="nv">doc = </span><span class="nx">@</span>
    <span class="nx">_queryGraphDB</span><span class="p">(</span><span class="nx">chypherQuery</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span>

  <span class="c1">#### Loads incoming and outgoing relationships</span>
  <span class="nv">Document::allRelationships = </span><span class="nf">(typeOfRelationship, options, cb) -&gt;</span>
    <span class="p">{</span><span class="nx">typeOfRelationship</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">cb</span><span class="p">}</span> <span class="o">=</span> <span class="nx">processtools</span><span class="p">.</span><span class="nx">sortTypeOfRelationshipAndOptionsAndCallback</span><span class="p">(</span><span class="nx">typeOfRelationship</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span>
    <span class="nv">options.direction = </span><span class="s">&#39;both&#39;</span>
    <span class="nv">options.referenceDocumentID = </span><span class="nx">@_id</span>
    <span class="nx">@queryRelationships</span><span class="p">(</span><span class="nx">typeOfRelationship</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span>

  <span class="c1">#### Loads in+outgoing relationships between to documents</span>
  <span class="nv">Document::allRelationshipsBetween = </span><span class="nf">(to, typeOfRelationship, options, cb) -&gt;</span>
    <span class="p">{</span><span class="nx">options</span><span class="p">,</span><span class="nx">cb</span><span class="p">}</span> <span class="o">=</span> <span class="nx">processtools</span><span class="p">.</span><span class="nx">sortOptionsAndCallback</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span><span class="nx">cb</span><span class="p">)</span>
    <span class="nv">from = </span><span class="nx">@</span>
    <span class="nx">options</span><span class="p">.</span><span class="nx">referenceDocumentID</span> <span class="o">?=</span> <span class="nx">from</span><span class="p">.</span><span class="nx">_id</span>
    <span class="nx">options</span><span class="p">.</span><span class="nx">direction</span> <span class="o">?=</span> <span class="s">&#39;both&#39;</span>
    <span class="nx">to</span><span class="p">.</span><span class="nx">getNode</span> <span class="nf">(err, endNode) -&gt;</span>
      <span class="k">return</span> <span class="nx">cb</span><span class="p">(</span><span class="nb">Error</span><span class="p">(</span><span class="s">&#39;-&gt; toDocument has no corresponding node&#39;</span><span class="p">,</span><span class="kc">null</span><span class="p">))</span> <span class="k">unless</span> <span class="nx">endNode</span>
      <span class="nv">options.endNodeId = </span><span class="nx">endNode</span><span class="p">.</span><span class="nx">id</span>
      <span class="nx">from</span><span class="p">.</span><span class="nx">queryRelationships</span><span class="p">(</span><span class="nx">typeOfRelationship</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span>

  <span class="c1">#### Loads incoming relationships between to documents</span>
  <span class="nv">Document::incomingRelationshipsFrom = </span><span class="nf">(to, typeOfRelationship, options, cb) -&gt;</span>
    <span class="p">{</span><span class="nx">options</span><span class="p">,</span><span class="nx">cb</span><span class="p">}</span> <span class="o">=</span> <span class="nx">processtools</span><span class="p">.</span><span class="nx">sortOptionsAndCallback</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span><span class="nx">cb</span><span class="p">)</span>
    <span class="nv">options.direction = </span><span class="s">&#39;incoming&#39;</span>
    <span class="nx">@allRelationshipsBetween</span><span class="p">(</span><span class="nx">to</span><span class="p">,</span> <span class="nx">typeOfRelationship</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span>

  <span class="c1">#### Loads outgoin relationships between to documents</span>
  <span class="nv">Document::outgoingRelationshipsTo = </span><span class="nf">(to, typeOfRelationship, options, cb) -&gt;</span>
    <span class="p">{</span><span class="nx">options</span><span class="p">,</span><span class="nx">cb</span><span class="p">}</span> <span class="o">=</span> <span class="nx">processtools</span><span class="p">.</span><span class="nx">sortOptionsAndCallback</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span><span class="nx">cb</span><span class="p">)</span>
    <span class="nv">options.direction = </span><span class="s">&#39;outgoing&#39;</span>
    <span class="nx">@allRelationshipsBetween</span><span class="p">(</span><span class="nx">to</span><span class="p">,</span> <span class="nx">typeOfRelationship</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span>

  <span class="c1">#### Loads incoming relationships</span>
  <span class="nv">Document::incomingRelationships = </span><span class="nf">(typeOfRelationship, options, cb) -&gt;</span>
    <span class="p">{</span><span class="nx">options</span><span class="p">,</span><span class="nx">cb</span><span class="p">}</span> <span class="o">=</span> <span class="nx">processtools</span><span class="p">.</span><span class="nx">sortOptionsAndCallback</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span><span class="nx">cb</span><span class="p">)</span>
    <span class="nv">options.direction = </span><span class="s">&#39;incoming&#39;</span>
    <span class="nv">options.referenceDocumentID = </span><span class="nx">@_id</span>
    <span class="nx">@queryRelationships</span><span class="p">(</span><span class="nx">typeOfRelationship</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span>

  <span class="c1">#### Loads outgoing relationships</span>
  <span class="nv">Document::outgoingRelationships = </span><span class="nf">(typeOfRelationship, options, cb) -&gt;</span>
    <span class="p">{</span><span class="nx">options</span><span class="p">,</span><span class="nx">cb</span><span class="p">}</span> <span class="o">=</span> <span class="nx">processtools</span><span class="p">.</span><span class="nx">sortOptionsAndCallback</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span><span class="nx">cb</span><span class="p">)</span>
    <span class="nv">options.direction = </span><span class="s">&#39;outgoing&#39;</span>
    <span class="nv">options.referenceDocumentID = </span><span class="nx">@_id</span>
    <span class="nx">@queryRelationships</span><span class="p">(</span><span class="nx">typeOfRelationship</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span>
  
  <span class="c1">#### Remove outgoing relationships to a specific Document</span>
  <span class="nv">Document::removeRelationshipsTo = </span><span class="nf">(doc, typeOfRelationship, options, cb) -&gt;</span>
    <span class="p">{</span><span class="nx">options</span><span class="p">,</span><span class="nx">cb</span><span class="p">}</span> <span class="o">=</span> <span class="nx">processtools</span><span class="p">.</span><span class="nx">sortOptionsAndCallback</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span><span class="nx">cb</span><span class="p">)</span>
    <span class="nx">options</span><span class="p">.</span><span class="nx">direction</span> <span class="o">?=</span> <span class="s">&#39;outgoing&#39;</span>
    <span class="nv">options.action = </span><span class="s">&#39;DELETE&#39;</span>
    <span class="nv">from = </span><span class="nx">@</span>
    <span class="nx">doc</span><span class="p">.</span><span class="nx">getNode</span> <span class="nf">(nodeErr, endNode) -&gt;</span>
      <span class="k">return</span> <span class="nx">cb</span><span class="p">(</span><span class="nx">nodeErr</span><span class="p">,</span> <span class="nx">endNode</span><span class="p">)</span> <span class="k">if</span> <span class="nx">nodeErr</span>
      <span class="nv">options.endNodeId = </span><span class="nx">endNode</span><span class="p">.</span><span class="nx">id</span>
      <span class="nx">from</span><span class="p">.</span><span class="nx">queryRelationships</span> <span class="nx">typeOfRelationship</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">cb</span>

  <span class="c1">#### Removes incoming relationships to a specific Document</span>
  <span class="nv">Document::removeRelationshipsFrom = </span><span class="nf">(doc, typeOfRelationship, options, cb) -&gt;</span>
    <span class="nv">to = </span><span class="nx">@</span>
    <span class="nx">doc</span><span class="p">.</span><span class="nx">removeRelationshipsTo</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">typeOfRelationship</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">cb</span>

  <span class="c1">#### Removes incoming ad outgoing relationships between two Documents</span>
  <span class="nv">Document::removeRelationshipsBetween = </span><span class="nf">(doc, typeOfRelationship, options, cb) -&gt;</span>
    <span class="p">{</span><span class="nx">options</span><span class="p">,</span><span class="nx">cb</span><span class="p">}</span> <span class="o">=</span> <span class="nx">processtools</span><span class="p">.</span><span class="nx">sortOptionsAndCallback</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span><span class="nx">cb</span><span class="p">)</span>
    <span class="nv">options.direction = </span><span class="s">&#39;both&#39;</span>
    <span class="nx">@removeRelationshipsTo</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">typeOfRelationship</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span>

  <span class="c1">#### Removes incoming and outgoing relationships to all Documents (useful bevor deleting a node/document)</span>
  <span class="nv">Document::removeRelationships = </span><span class="nf">(typeOfRelationship, options, cb) -&gt;</span>
    <span class="p">{</span><span class="nx">options</span><span class="p">,</span><span class="nx">cb</span><span class="p">}</span> <span class="o">=</span> <span class="nx">processtools</span><span class="p">.</span><span class="nx">sortOptionsAndCallback</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span><span class="nx">cb</span><span class="p">)</span>
    <span class="nv">options.direction = </span><span class="s">&#39;both&#39;</span>
    <span class="nv">options.action = </span><span class="s">&#39;DELETE&#39;</span>
    <span class="nx">@queryRelationships</span> <span class="nx">typeOfRelationship</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">cb</span>

  <span class="c1">#### Delete node including all incoming and outgoing relationships</span>
  <span class="nv">Document::removeNode = </span><span class="nf">(options, cb) -&gt;</span>
    <span class="p">{</span><span class="nx">options</span><span class="p">,</span><span class="nx">cb</span><span class="p">}</span> <span class="o">=</span> <span class="nx">processtools</span><span class="p">.</span><span class="nx">sortOptionsAndCallback</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span><span class="nx">cb</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">cb</span><span class="p">(</span><span class="nb">Error</span><span class="p">(</span><span class="s">&#39;No graphability enabled&#39;</span><span class="p">),</span> <span class="kc">null</span><span class="p">)</span> <span class="k">unless</span> <span class="nx">@schema</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;graphability&#39;</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>we don't distinguish between incoming and outgoing relationships here
would it make sense?! not sure...</p></div></div><div class="code"><div class="wrapper">    <span class="nx">options</span><span class="p">.</span><span class="nx">includeRelationships</span> <span class="o">?=</span> <span class="kc">true</span>
    <span class="nv">doc = </span><span class="nx">@</span>
    <span class="nx">doc</span><span class="p">.</span><span class="nx">getNode</span> <span class="nf">(err, node) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>if we have an error or no node found (as expected)</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="nx">err</span> <span class="o">or</span> <span class="k">typeof</span> <span class="nx">node</span> <span class="o">isnt</span> <span class="s">&#39;object&#39;</span>
        <span class="k">return</span> <span class="nx">cb</span><span class="p">(</span><span class="nx">err</span> <span class="o">||</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s">&#39;No corresponding node found to document #&#39;</span><span class="o">+</span><span class="nx">doc</span><span class="p">.</span><span class="nx">_id</span><span class="p">),</span> <span class="nx">node</span><span class="p">)</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nx">cb</span> <span class="o">is</span> <span class="s">&#39;function&#39;</span>
      <span class="k">else</span>
        <span class="nv">cypher = </span><span class="s">&quot;&quot;&quot;</span>
<span class="s">          START n = node(</span><span class="si">#{</span><span class="nx">node</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="s">)</span>
<span class="s">          MATCH n-[r?]-()</span>
<span class="s">          DELETE n</span><span class="si">#{</span><span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">includeRelationships</span> <span class="k">then</span> <span class="s">&#39;, r&#39;</span> <span class="k">else</span> <span class="s">&#39;&#39;</span><span class="si">}</span><span class="s"></span>
<span class="s">        &quot;&quot;&quot;</span>
        <span class="nx">_queryGraphDB</span><span class="p">(</span><span class="nx">cypher</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span>

  <span class="c1">#### Returns the shortest path between this and another document</span>
  <span class="nv">Document::shortestPathTo = </span><span class="nf">(doc, typeOfRelationship = &#39;&#39;, options, cb) -&gt;</span>
    <span class="p">{</span><span class="nx">options</span><span class="p">,</span><span class="nx">cb</span><span class="p">}</span> <span class="o">=</span> <span class="nx">processtools</span><span class="p">.</span><span class="nx">sortOptionsAndCallback</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span><span class="nx">cb</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">cb</span><span class="p">(</span><span class="nb">Error</span><span class="p">(</span><span class="s">&#39;No graphability enabled&#39;</span><span class="p">),</span> <span class="kc">null</span><span class="p">)</span> <span class="k">unless</span> <span class="nx">@schema</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;graphability&#39;</span><span class="p">)</span>
    <span class="nv">from = </span><span class="nx">@</span>
    <span class="nv">to = </span><span class="nx">doc</span>
    <span class="nx">from</span><span class="p">.</span><span class="nx">getNode</span> <span class="nf">(errFrom, fromNode) -&gt;</span> <span class="nx">to</span><span class="p">.</span><span class="nx">getNode</span> <span class="nf">(errTo, toNode) -&gt;</span>
      <span class="k">return</span> <span class="nx">cb</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s">&quot;Problem(s) getting from and/or to node&quot;</span><span class="p">))</span> <span class="k">if</span> <span class="nx">errFrom</span> <span class="o">or</span> <span class="nx">errTo</span> <span class="o">or</span> <span class="o">not</span> <span class="nx">fromNode</span> <span class="o">or</span> <span class="o">not</span> <span class="nx">toNode</span>
      <span class="nv">levelDeepness = </span><span class="mi">15</span>
      <span class="nv">query = </span><span class="s">&quot;&quot;&quot;</span>
<span class="s">        START a = node(</span><span class="si">#{</span><span class="nx">fromNode</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="s">), b = node(</span><span class="si">#{</span><span class="nx">toNode</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="s">) </span>
<span class="s">        MATCH path = shortestPath( a-[</span><span class="si">#{</span><span class="k">if</span> <span class="nx">typeOfRelationship</span> <span class="k">then</span> <span class="s">&#39;:&#39;</span><span class="o">+</span><span class="nx">typeOfRelationship</span> <span class="k">else</span> <span class="s">&#39;&#39;</span><span class="si">}</span><span class="s">*..</span><span class="si">#{</span><span class="nx">levelDeepness</span><span class="si">}</span><span class="s">]-&gt;b )</span>
<span class="s">        RETURN path;</span>
<span class="s">      &quot;&quot;&quot;</span>
      <span class="nv">options.processPart = </span><span class="s">&#39;path&#39;</span>
      <span class="nx">from</span><span class="p">.</span><span class="nx">queryGraph</span><span class="p">(</span><span class="nx">query</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span>

  <span class="nv">Document::dataForNode = </span><span class="nf">(options = {}) -&gt;</span>
    <span class="nv">self = </span><span class="nx">@</span>
    <span class="p">{</span><span class="nx">index</span><span class="p">}</span> <span class="o">=</span> <span class="nx">options</span>
    <span class="nx">index</span> <span class="o">?=</span> <span class="kc">false</span> <span class="c1"># returns fields for indexing if set to true; maybe as own method later</span>
    <span class="nv">paths = </span><span class="nx">self</span><span class="p">.</span><span class="nx">schema</span><span class="p">.</span><span class="nx">paths</span>
    <span class="nv">flattenSeperator = </span><span class="s">&#39;.&#39;</span> <span class="c1"># make it configurable?!</span>
    <span class="nv">values  = </span><span class="p">{}</span>
    <span class="nv">indexes = </span><span class="p">[]</span>
    <span class="k">for</span> <span class="nx">path</span> <span class="k">of</span> <span class="nx">paths</span>
      <span class="nv">definition = </span><span class="nx">paths</span><span class="p">[</span><span class="nx">path</span><span class="p">]</span>
      <span class="k">if</span> <span class="nx">index</span>
        <span class="nx">indexes</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="nx">flattenSeperator</span><span class="p">))</span> <span class="k">if</span> <span class="nx">definition</span><span class="p">.</span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">graph</span> <span class="o">is</span> <span class="kc">true</span> <span class="o">and</span> <span class="nx">definition</span><span class="p">.</span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">index</span> <span class="o">is</span> <span class="kc">true</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nx">definition</span><span class="p">.</span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">graph</span> <span class="o">is</span> <span class="kc">true</span>
        <span class="nx">values</span><span class="p">[</span><span class="nx">path</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="nx">flattenSeperator</span><span class="p">)]</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">index</span>
      <span class="nx">indexes</span> 
    <span class="k">else</span> <span class="k">if</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">values</span><span class="p">).</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="nx">values</span>
    <span class="k">else</span>
      <span class="kc">null</span>

  <span class="nv">Document::indexGraph = </span><span class="nf">(options, cb) -&gt;</span>
    <span class="p">{</span><span class="nx">options</span><span class="p">,</span><span class="nx">cb</span><span class="p">}</span> <span class="o">=</span> <span class="nx">processtools</span><span class="p">.</span><span class="nx">sortOptionsAndCallback</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span><span class="nx">cb</span><span class="p">)</span>
    <span class="nv">doc = </span><span class="nx">@</span>
    <span class="nv">node = </span><span class="nx">options</span><span class="p">.</span><span class="nx">node</span> <span class="o">or</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">_cached_node</span>
    <span class="nv">index = </span><span class="nx">doc</span><span class="p">.</span><span class="nx">dataForNode</span><span class="p">(</span><span class="nv">index: </span><span class="kc">true</span><span class="p">)</span>

    <span class="k">return</span> <span class="nx">cb</span><span class="p">(</span><span class="nb">Error</span><span class="p">(</span><span class="s">&#39;No node attached&#39;</span><span class="p">),</span> <span class="kc">null</span><span class="p">)</span>     <span class="k">unless</span> <span class="nx">node</span>
    <span class="k">return</span> <span class="nx">cb</span><span class="p">(</span><span class="nb">Error</span><span class="p">(</span><span class="s">&#39;No field(s) to index&#39;</span><span class="p">),</span> <span class="kc">null</span><span class="p">)</span> <span class="k">unless</span> <span class="nx">index</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>

    <span class="nv">join = </span><span class="nx">Join</span><span class="p">.</span><span class="nx">create</span><span class="p">()</span>
    <span class="nv">collectionName = </span><span class="nx">doc</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">name</span>
    
    <span class="k">for</span> <span class="nx">pathToIndex</span> <span class="k">in</span> <span class="nx">index</span>
      <span class="nv">value = </span><span class="nx">doc</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">pathToIndex</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>index if have a value</p></div></div><div class="code"><div class="wrapper">      <span class="nx">node</span><span class="p">.</span><span class="nx">index</span><span class="p">(</span><span class="nx">collectionName</span><span class="p">,</span> <span class="nx">pathToIndex</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">join</span><span class="p">.</span><span class="nx">add</span><span class="p">())</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nx">value</span> <span class="o">isnt</span> <span class="s">&#39;undefined&#39;</span>

    <span class="nx">join</span><span class="p">.</span><span class="nx">when</span> <span class="nf">-&gt;</span>
      <span class="nx">cb</span><span class="p">(</span><span class="nx">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">arguments</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nx">cb</span> <span class="o">is</span> <span class="s">&#39;function&#39;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>TODO: refactor -> split into more methods</p></div></div><div class="code"><div class="wrapper">  <span class="nv">Document::applyGraphRelationships = </span><span class="nf">(options, cb) -&gt;</span>
    <span class="p">{</span><span class="nx">options</span><span class="p">,</span><span class="nx">cb</span><span class="p">}</span> <span class="o">=</span> <span class="nx">processtools</span><span class="p">.</span><span class="nx">sortOptionsAndCallback</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span><span class="nx">cb</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">cb</span><span class="p">(</span><span class="nb">Error</span><span class="p">(</span><span class="s">&#39;No graphability enabled&#39;</span><span class="p">),</span> <span class="kc">null</span><span class="p">)</span> <span class="k">unless</span> <span class="nx">@schema</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;graphability&#39;</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>relationships will be stored permanently on this document
not for productive usage
-> it's deactivated by default, because I'm not sure that it'a good idea
to store informations redundant (CAP/syncing)</p></div></div><div class="code"><div class="wrapper">    <span class="nx">options</span><span class="p">.</span><span class="nx">doPersist</span> <span class="o">?=</span> <span class="kc">false</span>
    <span class="nv">sortedRelationships = </span><span class="p">{}</span>
    <span class="nv">typeOfRelationship = </span><span class="s">&#39;*&#39;</span> <span class="c1"># TODO: make optional</span>
    <span class="nv">doc = </span><span class="nx">@</span>

    <span class="nv">_finally = </span><span class="nf">(err, result, options) -&gt;</span>
      <span class="nv">doc._relationships = </span><span class="nx">sortedRelationships</span> <span class="c1"># attach to current document</span>
      <span class="nx">cb</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">_relationships</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nx">cb</span> <span class="o">is</span> <span class="s">&#39;function&#39;</span>

    <span class="nx">doc</span><span class="p">.</span><span class="nx">getNode</span> <span class="nx">options</span><span class="p">,</span> <span class="nf">(err, node, options) -&gt;</span>
      <span class="k">return</span> <span class="nx">_finally</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="k">if</span> <span class="nx">err</span>
      <span class="nx">doc</span><span class="p">.</span><span class="nx">allRelationships</span> <span class="nx">typeOfRelationship</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nf">(err, relationships, options) -&gt;</span>
        <span class="k">return</span> <span class="nx">_finally</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">relationships</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="k">if</span> <span class="nx">err</span>
        <span class="k">if</span> <span class="nx">relationships</span><span class="o">?</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>add relationships to object, sorted by type (see above for schema)          </p></div></div><div class="code"><div class="wrapper">          <span class="k">for</span> <span class="nx">relation</span> <span class="k">in</span> <span class="nx">relationships</span>
            <span class="k">if</span> <span class="nx">relation</span><span class="p">.</span><span class="nx">_data</span><span class="o">?</span><span class="p">.</span><span class="nx">type</span>
              <span class="nv">data = </span><span class="p">{}</span>
              <span class="k">for</span> <span class="nx">part</span> <span class="k">in</span> <span class="p">[</span> <span class="s">&#39;from&#39;</span><span class="p">,</span> <span class="s">&#39;to&#39;</span> <span class="p">]</span>
                <span class="p">{</span><span class="nx">collectionName</span><span class="p">,</span><span class="nx">_id</span><span class="p">}</span> <span class="o">=</span> <span class="nx">processtools</span><span class="p">.</span><span class="nx">extractCollectionAndId</span><span class="p">(</span><span class="nx">relation</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="s">&quot;_</span><span class="si">#{</span><span class="nx">part</span><span class="si">}</span><span class="s">&quot;</span><span class="p">])</span>
                <span class="nx">data</span><span class="p">[</span><span class="nx">part</span><span class="p">]</span> <span class="o">=</span>
                  <span class="nv">collection: </span><span class="nx">collectionName</span>
                  <span class="nv">_id: </span><span class="nx">processtools</span><span class="p">.</span><span class="nx">ObjectId</span><span class="p">(</span><span class="nx">_id</span><span class="p">)</span>
              <span class="nx">sortedRelationships</span><span class="p">[</span><span class="nx">relation</span><span class="p">.</span><span class="nx">_data</span><span class="p">.</span><span class="nx">type</span><span class="p">]</span> <span class="o">?=</span> <span class="p">[]</span>
              <span class="nx">sortedRelationships</span><span class="p">[</span><span class="nx">relation</span><span class="p">.</span><span class="nx">_data</span><span class="p">.</span><span class="nx">type</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
        <span class="nv">doc._relationships = </span><span class="nx">sortedRelationships</span>
        <span class="k">if</span> <span class="nx">typeOfRelationship</span> <span class="o">is</span> <span class="s">&#39;*&#39;</span>
          <span class="nv">conditions = </span><span class="p">{</span> <span class="nv">_relationships: </span><span class="nx">sortedRelationships</span> <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>update all -> slower</p></div></div><div class="code"><div class="wrapper">          <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">doPersist</span>
            <span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">debug</span><span class="o">?</span><span class="p">.</span><span class="nx">where</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">conditions</span><span class="p">)</span>
            <span class="nx">doc</span><span class="p">.</span><span class="nx">update</span> <span class="nx">conditions</span><span class="p">,</span> <span class="nf">(err, result) -&gt;</span> <span class="nx">_finally</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="nx">result</span><span class="p">,</span><span class="nx">options</span><span class="p">)</span>
          <span class="k">else</span>
            <span class="nx">_finally</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="kc">null</span><span class="p">,</span><span class="nx">options</span><span class="p">)</span>
        <span class="k">else</span>
          <span class="nv">key = </span><span class="s">&#39;_relationships.&#39;</span><span class="o">+</span><span class="nx">typeOfRelationship</span>
          <span class="nv">update = </span><span class="p">{}</span>
          <span class="nx">update</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">sortedRelationships</span><span class="p">[</span><span class="nx">typeOfRelationship</span><span class="p">]</span>
          <span class="nv">conditions = </span><span class="nx">update</span>
          <span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">debug</span><span class="o">?</span><span class="p">.</span><span class="nx">where</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">conditions</span><span class="p">)</span>
          <span class="k">if</span> <span class="nx">sortedRelationships</span><span class="p">[</span><span class="nx">typeOfRelationship</span><span class="p">]</span><span class="o">?</span>
            <span class="nx">doc</span><span class="p">.</span><span class="nx">update</span> <span class="nx">conditions</span><span class="p">,</span> <span class="nf">(err, result) -&gt;</span> <span class="nx">_finally</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="nx">result</span><span class="p">,</span><span class="nx">options</span><span class="p">)</span>
          <span class="k">else</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>remove/unset attribute</p></div></div><div class="code"><div class="wrapper">            <span class="nx">update</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># used to get mongodb query like -&gt; { $unset: { key: 1 } }</span>
            <span class="nv">conditions = </span><span class="p">{</span> <span class="nv">$unset: </span><span class="nx">update</span> <span class="p">}</span>
            
            <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">doPersist</span>
              <span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">debug</span><span class="o">?</span><span class="p">.</span><span class="nx">where</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">conditions</span><span class="p">)</span>
              <span class="nx">doc</span><span class="p">.</span><span class="nx">update</span> <span class="nx">conditions</span><span class="p">,</span> <span class="nf">(err, result) -&gt;</span> <span class="nx">_finally</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="nx">result</span><span class="p">,</span><span class="nx">options</span><span class="p">)</span>
            <span class="k">else</span>
              <span class="nx">_finally</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="kc">null</span><span class="p">,</span><span class="nx">options</span><span class="p">)</span>


  <span class="c1">#### Private method to query neo4j directly</span>
  <span class="c1">#### options -&gt; see Document::queryRelationships</span>
  <span class="nv">_queryGraphDB = </span><span class="nf">(cypher, options, cb) -&gt;</span>
    <span class="p">{</span><span class="nx">options</span><span class="p">,</span><span class="nx">cb</span><span class="p">}</span> <span class="o">=</span> <span class="nx">processtools</span><span class="p">.</span><span class="nx">sortOptionsAndCallback</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span><span class="nx">cb</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>TODO: type check
try to "guess" process part from last statement
TODO: nice or bad feature?! ... maybe too much magic </p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="o">not</span> <span class="nx">options</span><span class="p">.</span><span class="nx">processPart</span><span class="o">?</span> <span class="o">and</span> <span class="nx">cypher</span><span class="p">.</span><span class="nx">trim</span><span class="p">().</span><span class="nx">match</span><span class="p">(</span><span class="sr">/(RETURN|DELETE)\s+([a-zA-Z]+?)[;]*$/</span><span class="p">)</span><span class="o">?</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
      <span class="nv">options.processPart = </span><span class="nx">cypher</span><span class="p">.</span><span class="nx">trim</span><span class="p">().</span><span class="nx">match</span><span class="p">(</span><span class="sr">/(RETURN|DELETE)\s+([a-zA-Z]+?)[;]*$/</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
    <span class="nx">graphdb</span><span class="p">.</span><span class="nx">query</span> <span class="nx">cypher</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nf">(errGraph, map) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Adding cypher query for better debugging</p></div></div><div class="code"><div class="wrapper">      <span class="nv">options.debug = </span><span class="p">{}</span> <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">debug</span> <span class="o">is</span> <span class="kc">true</span>
      <span class="nx">options</span><span class="p">.</span><span class="nx">debug</span><span class="o">?</span><span class="p">.</span><span class="nx">cypher</span> <span class="o">?=</span> <span class="p">[]</span>
      <span class="nx">options</span><span class="p">.</span><span class="nx">debug</span><span class="o">?</span><span class="p">.</span><span class="nx">cypher</span><span class="o">?</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">cypher</span><span class="p">)</span>
      <span class="nx">options</span><span class="p">.</span><span class="nx">loadDocuments</span> <span class="o">?=</span> <span class="kc">true</span> <span class="c1"># load documents from mongodb</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>TODO: would it be helpful to have also the <code>native</code> result?
options.graphResult = map</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">loadDocuments</span> <span class="o">and</span> <span class="nx">map</span><span class="o">?</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>extract from result</p></div></div><div class="code"><div class="wrapper">        <span class="nv">data = </span><span class="k">for</span> <span class="nx">result</span> <span class="k">in</span> <span class="nx">map</span>
          <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">processPart</span>
            <span class="nx">result</span><span class="p">[</span><span class="nx">options</span><span class="p">.</span><span class="nx">processPart</span><span class="p">]</span>
          <span class="k">else</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>return first first property otherwise</p></div></div><div class="code"><div class="wrapper">            <span class="nx">result</span><span class="p">[</span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">result</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">if</span> <span class="nx">processtools</span><span class="p">.</span><span class="nx">constructorNameOf</span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">is</span> <span class="s">&#39;Relationship&#39;</span>
          <span class="nx">processtools</span><span class="p">.</span><span class="nx">populateResultWithDocuments</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">cb</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>TODO: distinguish between 'Path', 'Node' etc ...</p></div></div><div class="code"><div class="wrapper">        <span class="k">else</span>
          <span class="nx">processtools</span><span class="p">.</span><span class="nx">populateResultWithDocuments</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">cb</span>
      <span class="k">else</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>prevent <code>undefined is not a function</code> if no cb is given</p></div></div><div class="code"><div class="wrapper">        <span class="nx">cb</span><span class="p">(</span><span class="nx">errGraph</span><span class="p">,</span> <span class="nx">map</span> <span class="o">||</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nx">cb</span> <span class="o">is</span> <span class="s">&#39;function&#39;</span>

  <span class="c1">#### Cache node</span>
  <span class="k">if</span> <span class="nx">globalOptions</span><span class="p">.</span><span class="nx">cacheAttachedNodes</span>
    <span class="nv">Document::_cached_node = </span><span class="kc">null</span>
  </div></div></div></div></body></html>